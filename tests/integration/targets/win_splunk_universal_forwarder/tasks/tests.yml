---
# =============================================================================
# Splunk Universal Forwarder Windows Integration Tests
# =============================================================================

# Pre-Test Cleanup and Baseline Verification
- name: "SETUP | Ensure Splunk is not installed before tests"
  splunk.enterprise.win_splunk_universal_forwarder:
    state: absent
    purge: true
    install_dir: "{{ splunk_install_dir }}"
    temp_dir: "{{ splunk_temp_dir }}"
  register: pretest_cleanup

- name: "SETUP | Gather info when Splunk is not installed"
  splunk.enterprise.win_splunk_universal_forwarder_info:
    username: "{{ splunk_username }}"
    password: "{{ splunk_password }}"
    install_dir: "{{ splunk_install_dir }}"
  register: info_absent

- name: "SETUP | Verify info when Splunk is absent"
  ansible.builtin.assert:
    that:
      - info_absent is not changed
      - info_absent.state == 'absent'
      - info_absent.splunk_home == splunk_install_dir
    fail_msg: "Info module should report state=absent when Splunk is not installed"

# Main Test Block - ensures cleanup runs even on failure
- name: "Run all integration tests"
  block:
    # Install Tests
    - name: "INSTALL | Check mode - Install Splunk Universal Forwarder"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      check_mode: true
      register: install_check_mode

    - name: "INSTALL | Verify check mode reports changed"
      ansible.builtin.assert:
        that:
          - install_check_mode is changed
        fail_msg: "Check mode should report changed for new installation"

    - name: "INSTALL | Verify Splunk was not actually installed (check mode)"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_check_mode

    - name: "INSTALL | Assert Splunk still absent after check mode"
      ansible.builtin.assert:
        that:
          - info_after_check_mode.state == 'absent'
        fail_msg: "Splunk should not be installed after check mode"

    # Install - Actual
    - name: "INSTALL | Actually install Splunk Universal Forwarder"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: install_result

    - name: "INSTALL | Verify installation succeeded"
      ansible.builtin.assert:
        that:
          - install_result is changed
          - install_result.installed == true
          - install_result.installed_version is defined
        fail_msg: "Installation should succeed and report changed"

    - name: "INSTALL | Gather info after installation"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_install

    - name: "INSTALL | Verify info after installation"
      ansible.builtin.assert:
        that:
          - info_after_install.state == 'present'
          - info_after_install.version == splunk_version_base
          - info_after_install.splunk_home == splunk_install_dir
        fail_msg: "Info module should report correct state and version after install"

    # Install - Idempotency
    - name: "INSTALL | Idempotency - Run install again with same version"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: install_idempotent

    - name: "INSTALL | Verify idempotency - no changes"
      ansible.builtin.assert:
        that:
          - install_idempotent is not changed
        fail_msg: "Running install with same version should be idempotent (no changes)"

    # Forward Servers Tests
    # Set Forward Servers - Check Mode
    - name: "FORWARD_SERVERS | Check mode - Set initial forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.29.168:9997"
          - "10.46.29.214:9997"
      check_mode: true
      register: fwd_set_check_mode

    - name: "FORWARD_SERVERS | Verify check mode reports changed for new servers"
      ansible.builtin.assert:
        that:
          - fwd_set_check_mode is changed
        fail_msg: "Check mode should report changed when setting new forward servers"

    # Set Forward Servers - Actual
    - name: "FORWARD_SERVERS | Set initial forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.29.168:9997"
          - "10.46.29.214:9997"
      register: fwd_set_result

    - name: "FORWARD_SERVERS | Verify forward servers were set"
      ansible.builtin.assert:
        that:
          - fwd_set_result is changed
        fail_msg: "Setting forward servers should report changed"

    - name: "FORWARD_SERVERS | Gather info to verify forward servers"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_with_fwd_servers

    - name: "FORWARD_SERVERS | Verify forward servers in info output"
      ansible.builtin.assert:
        that:
          - info_with_fwd_servers.forward_servers | length == 2
        fail_msg: "Info should show configured forward servers"

    # Set Forward Servers - Idempotency
    - name: "FORWARD_SERVERS | Idempotency - Set same forward servers again"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.29.168:9997"
          - "10.46.29.214:9997"
      register: fwd_set_idempotent

    - name: "FORWARD_SERVERS | Verify idempotency"
      ansible.builtin.assert:
        that:
          - fwd_set_idempotent is not changed
        fail_msg: "Setting same forward servers should be idempotent"

    # Update Forward Servers - Check Mode
    - name: "FORWARD_SERVERS | Check mode - Update forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.30.100:9997"
          - "10.46.30.101:9997"
          - "10.46.30.102:9997"
      check_mode: true
      register: fwd_update_check_mode

    - name: "FORWARD_SERVERS | Verify check mode reports changed for update"
      ansible.builtin.assert:
        that:
          - fwd_update_check_mode is changed
        fail_msg: "Check mode should report changed when updating forward servers"

    # Update Forward Servers - Actual
    - name: "FORWARD_SERVERS | Update forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers:
          - "10.46.30.100:9997"
          - "10.46.30.101:9997"
          - "10.46.30.102:9997"
      register: fwd_update_result

    - name: "FORWARD_SERVERS | Verify forward servers were updated"
      ansible.builtin.assert:
        that:
          - fwd_update_result is changed
        fail_msg: "Updating forward servers should report changed"

    - name: "FORWARD_SERVERS | Gather info to verify updated forward servers"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_with_updated_fwd

    - name: "FORWARD_SERVERS | Verify updated forward servers in info"
      ansible.builtin.assert:
        that:
          - info_with_updated_fwd.forward_servers | length == 3
        fail_msg: "Info should show updated forward servers"

    # Remove Forward Servers - Check Mode
    - name: "FORWARD_SERVERS | Check mode - Remove all forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers: []
      check_mode: true
      register: fwd_remove_check_mode

    - name: "FORWARD_SERVERS | Verify check mode reports changed for removal"
      ansible.builtin.assert:
        that:
          - fwd_remove_check_mode is changed
        fail_msg: "Check mode should report changed when removing forward servers"

    # Remove Forward Servers - Actual
    - name: "FORWARD_SERVERS | Remove all forward servers"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers: []
      register: fwd_remove_result

    - name: "FORWARD_SERVERS | Verify forward servers were removed"
      ansible.builtin.assert:
        that:
          - fwd_remove_result is changed
        fail_msg: "Removing forward servers should report changed"

    - name: "FORWARD_SERVERS | Gather info to verify no forward servers"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_no_fwd_servers

    - name: "FORWARD_SERVERS | Verify no forward servers in info"
      ansible.builtin.assert:
        that:
          - info_no_fwd_servers.forward_servers | length == 0
        fail_msg: "Info should show no forward servers after removal"

    # Remove Forward Servers - Idempotency
    - name: "FORWARD_SERVERS | Idempotency - Remove forward servers again"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        forward_servers: []
      register: fwd_remove_idempotent

    - name: "FORWARD_SERVERS | Verify removal idempotency"
      ansible.builtin.assert:
        that:
          - fwd_remove_idempotent is not changed
        fail_msg: "Removing already-removed forward servers should be idempotent"

    # Deployment Server Tests
    # Set Deployment Server - Check Mode
    - name: "DEPLOYMENT_SERVER | Check mode - Set initial deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.29.168:8089"
      check_mode: true
      register: ds_set_check_mode

    - name: "DEPLOYMENT_SERVER | Verify check mode reports changed"
      ansible.builtin.assert:
        that:
          - ds_set_check_mode is changed
        fail_msg: "Check mode should report changed when setting deployment server"

    # Set Deployment Server - Actual
    - name: "DEPLOYMENT_SERVER | Set initial deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.29.168:8089"
      register: ds_set_result

    - name: "DEPLOYMENT_SERVER | Verify deployment server was set"
      ansible.builtin.assert:
        that:
          - ds_set_result is changed
        fail_msg: "Setting deployment server should report changed"

    - name: "DEPLOYMENT_SERVER | Gather info to verify deployment server"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_with_ds

    - name: "DEPLOYMENT_SERVER | Verify deployment server in info"
      ansible.builtin.assert:
        that:
          - info_with_ds.deployment_server is defined
          - "'10.46.29.168:8089' in info_with_ds.deployment_server"
        fail_msg: "Info should show configured deployment server"

    # Set Deployment Server - Idempotency
    - name: "DEPLOYMENT_SERVER | Idempotency - Set same deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.29.168:8089"
      register: ds_set_idempotent

    - name: "DEPLOYMENT_SERVER | Verify idempotency"
      ansible.builtin.assert:
        that:
          - ds_set_idempotent is not changed
        fail_msg: "Setting same deployment server should be idempotent"

    # Update Deployment Server - Check Mode
    - name: "DEPLOYMENT_SERVER | Check mode - Update deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.30.200:8089"
      check_mode: true
      register: ds_update_check_mode

    - name: "DEPLOYMENT_SERVER | Verify check mode reports changed for update"
      ansible.builtin.assert:
        that:
          - ds_update_check_mode is changed
        fail_msg: "Check mode should report changed when updating deployment server"

    # Update Deployment Server - Actual
    - name: "DEPLOYMENT_SERVER | Update deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "10.46.30.200:8089"
      register: ds_update_result

    - name: "DEPLOYMENT_SERVER | Verify deployment server was updated"
      ansible.builtin.assert:
        that:
          - ds_update_result is changed
        fail_msg: "Updating deployment server should report changed"

    - name: "DEPLOYMENT_SERVER | Gather info to verify updated deployment server"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_with_updated_ds

    - name: "DEPLOYMENT_SERVER | Verify updated deployment server in info"
      ansible.builtin.assert:
        that:
          - info_with_updated_ds.deployment_server is defined
          - "'10.46.30.200:8089' in info_with_updated_ds.deployment_server"
        fail_msg: "Info should show updated deployment server"

    # Remove Deployment Server - Check Mode
    - name: "DEPLOYMENT_SERVER | Check mode - Remove deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "NONE"
      check_mode: true
      register: ds_remove_check_mode

    - name: "DEPLOYMENT_SERVER | Verify check mode reports changed for removal"
      ansible.builtin.assert:
        that:
          - ds_remove_check_mode is changed
        fail_msg: "Check mode should report changed when removing deployment server"

    # Remove Deployment Server - Actual
    - name: "DEPLOYMENT_SERVER | Remove deployment server"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "NONE"
      register: ds_remove_result

    - name: "DEPLOYMENT_SERVER | Verify deployment server was removed"
      ansible.builtin.assert:
        that:
          - ds_remove_result is changed
          - ds_remove_result.deploymentclient_conf_removed | default(false) == true
        fail_msg: "Removing deployment server should report changed"

    - name: "DEPLOYMENT_SERVER | Gather info to verify no deployment server"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_no_ds

    - name: "DEPLOYMENT_SERVER | Verify no deployment server in info"
      ansible.builtin.assert:
        that:
          - info_no_ds.deployment_server is not defined or info_no_ds.deployment_server == ''
        fail_msg: "Info should show no deployment server after removal"

    # Remove Deployment Server - Idempotency
    - name: "DEPLOYMENT_SERVER | Idempotency - Remove deployment server again"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        deployment_server: "NONE"
      register: ds_remove_idempotent

    - name: "DEPLOYMENT_SERVER | Verify removal idempotency"
      ansible.builtin.assert:
        that:
          - ds_remove_idempotent is not changed
        fail_msg: "Removing already-removed deployment server should be idempotent"

    # Upgrade Tests
    # Upgrade - Check Mode
    - name: "UPGRADE | Check mode - Upgrade to newer version"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_upgrade }}"
        release_id: "{{ splunk_release_id_upgrade }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      check_mode: true
      register: upgrade_check_mode

    - name: "UPGRADE | Verify check mode reports changed for upgrade"
      ansible.builtin.assert:
        that:
          - upgrade_check_mode is changed
        fail_msg: "Check mode should report changed for upgrade"

    - name: "UPGRADE | Verify version unchanged after check mode"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_upgrade_check

    - name: "UPGRADE | Assert version still base after check mode"
      ansible.builtin.assert:
        that:
          - info_after_upgrade_check.version == splunk_version_base
        fail_msg: "Version should not change in check mode"

    # Upgrade - Actual
    - name: "UPGRADE | Actually upgrade to newer version"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_upgrade }}"
        release_id: "{{ splunk_release_id_upgrade }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: upgrade_result

    - name: "UPGRADE | Verify upgrade succeeded"
      ansible.builtin.assert:
        that:
          - upgrade_result is changed
          - upgrade_result.installed == true
        fail_msg: "Upgrade should succeed and report changed"

    - name: "UPGRADE | Gather info after upgrade"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_upgrade

    - name: "UPGRADE | Verify upgraded version"
      ansible.builtin.assert:
        that:
          - info_after_upgrade.state == 'present'
          - info_after_upgrade.version == splunk_version_upgrade
        fail_msg: "Version should be upgraded to {{ splunk_version_upgrade }}"

    # Upgrade - Idempotency
    - name: "UPGRADE | Idempotency - Run upgrade again with same version"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_upgrade }}"
        release_id: "{{ splunk_release_id_upgrade }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: upgrade_idempotent

    - name: "UPGRADE | Verify idempotency"
      ansible.builtin.assert:
        that:
          - upgrade_idempotent is not changed
        fail_msg: "Running with same upgraded version should be idempotent"

    # Downgrade Tests (Should Fail)
    - name: "DOWNGRADE | Attempt to downgrade (should fail)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_downgrade }}"
        release_id: "{{ splunk_release_id_downgrade }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: local_system
      register: downgrade_result
      failed_when:
        - downgrade_result.failed == false
        - "'Downgrade is not supported' not in downgrade_result.msg"

    - name: "DOWNGRADE | Verify version unchanged after failed downgrade"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_downgrade_attempt

    - name: "DOWNGRADE | Assert version still upgraded version"
      ansible.builtin.assert:
        that:
          - info_after_downgrade_attempt.version == splunk_version_upgrade
        fail_msg: "Version should remain {{ splunk_version_upgrade }} after failed downgrade"

    # Uninstall Tests
    # Uninstall - Check Mode
    - name: "UNINSTALL | Check mode - Uninstall Splunk"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
      check_mode: true
      register: uninstall_check_mode

    - name: "UNINSTALL | Verify check mode reports changed"
      ansible.builtin.assert:
        that:
          - uninstall_check_mode is changed
        fail_msg: "Check mode should report changed for uninstall"

    - name: "UNINSTALL | Verify Splunk still installed after check mode"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_uninstall_check

    - name: "UNINSTALL | Assert Splunk still present after check mode"
      ansible.builtin.assert:
        that:
          - info_after_uninstall_check.state == 'present'
        fail_msg: "Splunk should still be installed after uninstall check mode"

    # Uninstall - Actual (without purge)
    - name: "UNINSTALL | Actually uninstall Splunk (no purge)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        purge: false
      register: uninstall_result

    - name: "UNINSTALL | Verify uninstall succeeded"
      ansible.builtin.assert:
        that:
          - uninstall_result is changed
          - uninstall_result.installed == false
        fail_msg: "Uninstall should succeed and report changed"

    - name: "UNINSTALL | Gather info after uninstall"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_after_uninstall

    - name: "UNINSTALL | Verify Splunk is absent"
      ansible.builtin.assert:
        that:
          - info_after_uninstall.state == 'absent'
        fail_msg: "Info should report state=absent after uninstall"

    # Uninstall - Idempotency
    - name: "UNINSTALL | Idempotency - Uninstall again"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
      register: uninstall_idempotent

    - name: "UNINSTALL | Verify idempotency"
      ansible.builtin.assert:
        that:
          - uninstall_idempotent is not changed
        fail_msg: "Uninstalling already-uninstalled Splunk should be idempotent"

    # Virtual Service Account Installation Test
    - name: "VSA_INSTALL | Install Splunk with Virtual Service Account (with retries)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: present
        version: "{{ splunk_version_base }}"
        release_id: "{{ splunk_release_id_base }}"
        splunk_username: "{{ splunk_username }}"
        splunk_password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        service_account_type: virtual_service_account
      register: vsa_install_result
      retries: 5
      delay: 10
      until: vsa_install_result is succeeded

    - name: "VSA_INSTALL | Verify VSA installation succeeded"
      ansible.builtin.assert:
        that:
          - vsa_install_result is changed or vsa_install_result is succeeded
          - vsa_install_result.installed == true
        fail_msg: "Virtual Service Account installation should succeed"

    - name: "VSA_INSTALL | Gather info after VSA installation"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: info_vsa_install

    - name: "VSA_INSTALL | Verify Splunk is running after VSA install"
      ansible.builtin.assert:
        that:
          - info_vsa_install.state == 'present'
          - info_vsa_install.service.status == 'Running'
        fail_msg: "Splunk should be running after VSA installation"

  # Always cleanup - runs even if tests fail
  always:
    - name: "CLEANUP | Final uninstall with purge (always runs)"
      splunk.enterprise.win_splunk_universal_forwarder:
        state: absent
        install_dir: "{{ splunk_install_dir }}"
        temp_dir: "{{ splunk_temp_dir }}"
        purge: true
      register: final_cleanup

    - name: "CLEANUP | Verify Splunk is completely removed"
      splunk.enterprise.win_splunk_universal_forwarder_info:
        username: "{{ splunk_username }}"
        password: "{{ splunk_password }}"
        install_dir: "{{ splunk_install_dir }}"
      register: final_info

    - name: "CLEANUP | Assert final state is absent"
      ansible.builtin.assert:
        that:
          - final_info.state == 'absent'
        fail_msg: "Splunk should be completely removed after cleanup"
